#!/usr/bin/ruby
##########################################################################
#  Copyright (C) 2012 Ramos, Gast√≥n - ramos.gaston@gmail.com
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
#  GNU General Public License for more details.
#
#########################################################################
require 'csv'
require 'erb'
require "import_arg_parser"
require "migral/migration"

def parse_and_create_record(record_data, attributes, sequel_class)
  record = {}
  attributes.each do |a|
    index = attributes.index(a)
    record[a] = record_data[index]
  end

  if DEBUG
    puts c
  else
    print "+"
  end
  sequel_class.create(record)
end

def delete_table_data
  puts "\n*** Im going to delete all data in #{@sequel_class}!!! ******"
  puts "\nPress ctrl + c to cancel"
  sleep 5
  puts "Deleting #{@sequel_class}..."
  @sequel_class.delete
end

def process_row(row)
  if @action == "gen_migration"
    @migration.sum_attr_size! row

    if @row_number +1 == @row_count
      puts @migration.generate @attributes, @table_name
    end
  end

  if @action == "import"
    parse_and_create_record row, @attributes, @sequel_class
  end
end

opt = ArgParser.parse(ARGV)

if ARGV[3] == 'debug'
  DEBUG = true
else
  DEBUG = false
end

@csv_file     = opt.csv_file
@action       = opt.action
@separator    = opt.separator || ","
@sequel_class = Kernel.const_get opt.sequel_class if @action == "import"
@table_name   = opt.table_name if @action == "gen_migration"
@first_row    = true
@row_count    = %x{wc -l < "#{@csv_file}"}.to_i
@row_number   = 0
@migration    = Migral::Migration.new

CSV.foreach(@csv_file, {:col_sep => @separator}) do |row|
  if @first_row
    @attributes = row
    @first_row  = false

    if @action == "import"
      delete_table_data
      puts "\n==> Importing records data from #{@csv_file}..."
    end
  else
    process_row row
  end
  @row_number += 1
end

